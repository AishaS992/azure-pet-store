name: Deploy ETL Infrastructure

parameters:
- name: resourceGroupName
  displayName: Resource Group
  type: string
  default: ETLTest
- name: location
  displayName: Location
  type: string
  default: eastus
  values:
  - eastus
  - eastus2
  - westus
  - westus2
- name: cosmosAccountName
  displayName: Cosmos Account Name
  type: string
  default: AzurePetStore
- name: cosmosDatabaseName
  displayName: Cosmos Database Name
  type: string
  default: E-Commerce
- name: cosmosContainerName
  displayName: Cosmos Container Name
  type: string
  default: Orders
- name: cosmosThroughput
  displayName: Cosmos Throughput
  type: string
  default: 400

trigger: none

variables:
  vmImageName: 'ubuntu-latest'
  azureServiceConnection: 'Azure'
  templateFile: 'petstore/iac/bicep/etl/main.bicep'
pool:
  vmImage: $(vmImageName)

steps:
- task: AzureCLI@2
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az --version
      az group create --name ${{ parameters.resourceGroupName }} --location ${{ parameters.location }}
      az deployment group create --resource-group ${{ parameters.resourceGroupName }} --template-file $(templateFile) --parameters cosmosAccountName=${{ parameters.cosmosAccountName }} --parameters cosmosPrimaryRegion=${{ parameters.location }} --parameters cosmosDatabaseName=${{ parameters.cosmosDatabaseName }} --parameters cosmosContainerName=${{ parameters.cosmosContainerName }} --parameters cosmosThroughput=${{ parameters.cosmosThroughput }}